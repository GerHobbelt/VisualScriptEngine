COMPILER = $(CXX)
COMPILER_FLAGS = -Wall -std=c++11
COMPATIBLE_OS = 0

LIBRARY_PREFIX =
LIBRARY_EXTENSION =
EXECUTABLE_EXTENSION =
COMPATIBLE_OS =
PATHSEP =

ifeq ($(OS), Windows_NT)
	LIBRARY_EXTENSION = .lib
	EXECUTABLE_EXTENSION = .exe
	COMPATIBLE_OS = 1
	PATHSEP = \\
else
	UNAME = $(shell uname -s)
	ifeq ($(UNAME), Linux)
		CURRENTPATH = $(shell pwd)
		export LD_LIBRARY_PATH = $(CURRENTPATH)/$(BINARIES_FOLDER):$LD_LIBRARY_PATH
		LIBRARY_PREFIX = lib
		LIBRARY_EXTENSION = .so
		COMPILER_FLAGS += -fPIC
		COMPATIBLE_OS = 1
		PATHSEP = /
	endif
endif

ifeq ($(OS), Windows_NT)
define CopyFiles
	xcopy "$(1)" "$(2)" /I /D /Y
endef
else
define CopyFiles
	rsync $(1) $(2) -c
endef
endif

ifeq ($(COMPATIBLE_OS), 0)
$(error Incompatible operating system)
endif

SOURCES_FOLDER = ..$(PATHSEP)..$(PATHSEP)Sources
BINARIES_FOLDER = Binaries
OBJECTS_FOLDER = $(BINARIES_FOLDER)$(PATHSEP)Objects

NODE_ENGINE_LIB_NAME = NodeEngine
NODE_ENGINE_LIB = $(BINARIES_FOLDER)$(PATHSEP)$(LIBRARY_PREFIX)$(NODE_ENGINE_LIB_NAME)$(LIBRARY_EXTENSION)

NODE_UI_ENGINE_LIB_NAME = NodeUIEngine
NODE_UI_ENGINE_LIB = $(BINARIES_FOLDER)$(PATHSEP)$(LIBRARY_PREFIX)$(NODE_UI_ENGINE_LIB_NAME)$(LIBRARY_EXTENSION)

BUILT_IN_NODES_LIB_NAME = BuiltInNodes
BUILT_IN_NODES_LIB = $(BINARIES_FOLDER)$(PATHSEP)$(LIBRARY_PREFIX)$(BUILT_IN_NODES_LIB_NAME)$(LIBRARY_EXTENSION)

NODE_ENGINE_TEST_EXE_NAME = NodeEngineTest
NODE_ENGINE_TEST_EXE = $(BINARIES_FOLDER)$(PATHSEP)$(NODE_ENGINE_TEST_EXE_NAME)$(EXECUTABLE_EXTENSION)

all: $(NODE_ENGINE_LIB) $(NODE_UI_ENGINE_LIB) $(BUILT_IN_NODES_LIB) $(NODE_ENGINE_TEST_EXE)

test:
	$(NODE_ENGINE_TEST_EXE)

clean:
	rm -rf $(BINARIES_FOLDER)

# NodeEngine

NODE_ENGINE_HEADERS_FOLDER = $(SOURCES_FOLDER)$(PATHSEP)$(NODE_ENGINE_LIB_NAME)$(PATHSEP)Headers
NODE_ENGINE_SOURCES_FOLDER = $(SOURCES_FOLDER)$(PATHSEP)$(NODE_ENGINE_LIB_NAME)$(PATHSEP)Sources
NODE_ENGINE_SOURCE_FILES = \
	$(NODE_ENGINE_SOURCES_FOLDER)$(PATHSEP)Checksum.cpp \
	$(NODE_ENGINE_SOURCES_FOLDER)$(PATHSEP)ConnectionManager.cpp \
	$(NODE_ENGINE_SOURCES_FOLDER)$(PATHSEP)Debug.cpp \
	$(NODE_ENGINE_SOURCES_FOLDER)$(PATHSEP)EvaluationEnv.cpp \
	$(NODE_ENGINE_SOURCES_FOLDER)$(PATHSEP)InputSlot.cpp \
	$(NODE_ENGINE_SOURCES_FOLDER)$(PATHSEP)MemoryStream.cpp \
	$(NODE_ENGINE_SOURCES_FOLDER)$(PATHSEP)Node.cpp \
	$(NODE_ENGINE_SOURCES_FOLDER)$(PATHSEP)NodeEngineUtilities.cpp \
	$(NODE_ENGINE_SOURCES_FOLDER)$(PATHSEP)NodeId.cpp \
	$(NODE_ENGINE_SOURCES_FOLDER)$(PATHSEP)NodeManager.cpp \
	$(NODE_ENGINE_SOURCES_FOLDER)$(PATHSEP)NodeValueCache.cpp \
	$(NODE_ENGINE_SOURCES_FOLDER)$(PATHSEP)OutputSlot.cpp \
	$(NODE_ENGINE_SOURCES_FOLDER)$(PATHSEP)SingleValues.cpp \
	$(NODE_ENGINE_SOURCES_FOLDER)$(PATHSEP)Serializable.cpp \
	$(NODE_ENGINE_SOURCES_FOLDER)$(PATHSEP)Stamp.cpp \
	$(NODE_ENGINE_SOURCES_FOLDER)$(PATHSEP)Stream.cpp \
	$(NODE_ENGINE_SOURCES_FOLDER)$(PATHSEP)Slot.cpp \
	$(NODE_ENGINE_SOURCES_FOLDER)$(PATHSEP)SlotId.cpp \
	$(NODE_ENGINE_SOURCES_FOLDER)$(PATHSEP)Value.cpp \
	$(NODE_ENGINE_SOURCES_FOLDER)$(PATHSEP)ValueCombination.cpp \

NODE_ENGINE_OBJECTS_FOLDER = $(OBJECTS_FOLDER)$(PATHSEP)$(NODE_ENGINE_LIB_NAME)
NODE_ENGINE_OBJECTS = $(NODE_ENGINE_SOURCE_FILES:$(NODE_ENGINE_SOURCES_FOLDER)$(PATHSEP)%.cpp=$(NODE_ENGINE_OBJECTS_FOLDER)$(PATHSEP)%.o)

$(NODE_ENGINE_LIB) : $(NODE_ENGINE_OBJECTS)
	$(COMPILER) -shared -o $@ $^

$(NODE_ENGINE_OBJECTS_FOLDER) :
	mkdir -p $(NODE_ENGINE_OBJECTS_FOLDER)

$(NODE_ENGINE_OBJECTS_FOLDER)$(PATHSEP)%.o : $(NODE_ENGINE_SOURCES_FOLDER)$(PATHSEP)%.cpp | $(NODE_ENGINE_OBJECTS_FOLDER)
	$(COMPILER) -I$(NODE_ENGINE_HEADERS_FOLDER) $(COMPILER_FLAGS) -o $@ -c $<

# NodeUIEngine

NODE_UI_ENGINE_HEADERS_FOLDER = $(SOURCES_FOLDER)$(PATHSEP)$(NODE_UI_ENGINE_LIB_NAME)$(PATHSEP)Headers
NODE_UI_ENGINE_SOURCES_FOLDER = $(SOURCES_FOLDER)$(PATHSEP)$(NODE_UI_ENGINE_LIB_NAME)$(PATHSEP)Sources
NODE_UI_ENGINE_SOURCE_FILES = \
	$(NODE_UI_ENGINE_SOURCES_FOLDER)$(PATHSEP)CommandStructure.cpp \
	$(NODE_UI_ENGINE_SOURCES_FOLDER)$(PATHSEP)CommonUINodeParameters.cpp \
	$(NODE_UI_ENGINE_SOURCES_FOLDER)$(PATHSEP)ContextDecorators.cpp \
	$(NODE_UI_ENGINE_SOURCES_FOLDER)$(PATHSEP)Drawing.cpp \
	$(NODE_UI_ENGINE_SOURCES_FOLDER)$(PATHSEP)DrawingContext.cpp \
	$(NODE_UI_ENGINE_SOURCES_FOLDER)$(PATHSEP)DrawingImage.cpp \
	$(NODE_UI_ENGINE_SOURCES_FOLDER)$(PATHSEP)EventHandlers.cpp \
	$(NODE_UI_ENGINE_SOURCES_FOLDER)$(PATHSEP)Geometry.cpp \
	$(NODE_UI_ENGINE_SOURCES_FOLDER)$(PATHSEP)MouseEventHandler.cpp \
	$(NODE_UI_ENGINE_SOURCES_FOLDER)$(PATHSEP)NodeDrawingImage.cpp \
	$(NODE_UI_ENGINE_SOURCES_FOLDER)$(PATHSEP)NodeEditor.cpp \
	$(NODE_UI_ENGINE_SOURCES_FOLDER)$(PATHSEP)NodeUIEnvironment.cpp \
	$(NODE_UI_ENGINE_SOURCES_FOLDER)$(PATHSEP)NodeUIInteractionHandler.cpp \
	$(NODE_UI_ENGINE_SOURCES_FOLDER)$(PATHSEP)NodeUIManager.cpp \
	$(NODE_UI_ENGINE_SOURCES_FOLDER)$(PATHSEP)NodeUIManagerDrawer.cpp \
	$(NODE_UI_ENGINE_SOURCES_FOLDER)$(PATHSEP)NodeUIPanelDrawer.cpp \
	$(NODE_UI_ENGINE_SOURCES_FOLDER)$(PATHSEP)SkinParams.cpp \
	$(NODE_UI_ENGINE_SOURCES_FOLDER)$(PATHSEP)UIEventHandlers.cpp \
	$(NODE_UI_ENGINE_SOURCES_FOLDER)$(PATHSEP)UIInputSlot.cpp \
	$(NODE_UI_ENGINE_SOURCES_FOLDER)$(PATHSEP)UIItemFinder.cpp \
	$(NODE_UI_ENGINE_SOURCES_FOLDER)$(PATHSEP)UINode.cpp \
	$(NODE_UI_ENGINE_SOURCES_FOLDER)$(PATHSEP)UINodeCommands.cpp \
	$(NODE_UI_ENGINE_SOURCES_FOLDER)$(PATHSEP)UINodeCommandStructure.cpp \
	$(NODE_UI_ENGINE_SOURCES_FOLDER)$(PATHSEP)UINodeParameters.cpp \
	$(NODE_UI_ENGINE_SOURCES_FOLDER)$(PATHSEP)UIOutputSlot.cpp \
	$(NODE_UI_ENGINE_SOURCES_FOLDER)$(PATHSEP)ViewBox.cpp \
			
NODE_UI_ENGINE_OBJECTS_FOLDER = $(OBJECTS_FOLDER)$(PATHSEP)$(NODE_UI_ENGINE_LIB_NAME)
NODE_UI_ENGINE_OBJECTS = $(NODE_UI_ENGINE_SOURCE_FILES:$(NODE_UI_ENGINE_SOURCES_FOLDER)$(PATHSEP)%.cpp=$(NODE_UI_ENGINE_OBJECTS_FOLDER)$(PATHSEP)%.o)

$(NODE_UI_ENGINE_LIB) : $(NODE_UI_ENGINE_OBJECTS)
	$(COMPILER) -shared -o $@ $^ -L$(BINARIES_FOLDER) -l$(NODE_ENGINE_LIB_NAME)

$(NODE_UI_ENGINE_OBJECTS_FOLDER) :
	mkdir -p $(NODE_UI_ENGINE_OBJECTS_FOLDER)

$(NODE_UI_ENGINE_OBJECTS_FOLDER)$(PATHSEP)%.o : $(NODE_UI_ENGINE_SOURCES_FOLDER)$(PATHSEP)%.cpp | $(NODE_UI_ENGINE_OBJECTS_FOLDER)
	$(COMPILER) -I$(NODE_ENGINE_HEADERS_FOLDER) -I$(NODE_UI_ENGINE_HEADERS_FOLDER) $(COMPILER_FLAGS) -o $@ -c $<

# BuiltInNodes

BUILT_IN_NODES_HEADERS_FOLDER = $(SOURCES_FOLDER)$(PATHSEP)$(BUILT_IN_NODES_LIB_NAME)$(PATHSEP)Headers
BUILT_IN_NODES_SOURCES_FOLDER = $(SOURCES_FOLDER)$(PATHSEP)$(BUILT_IN_NODES_LIB_NAME)$(PATHSEP)Sources
BUILT_IN_NODES_SOURCE_FILES = \
	$(BUILT_IN_NODES_SOURCES_FOLDER)$(PATHSEP)BaseUINodes.cpp \
	$(BUILT_IN_NODES_SOURCES_FOLDER)$(PATHSEP)InputUINodes.cpp \
	$(BUILT_IN_NODES_SOURCES_FOLDER)$(PATHSEP)ViewerUINodes.cpp \
	$(BUILT_IN_NODES_SOURCES_FOLDER)$(PATHSEP)UINodePanels.cpp \
	$(BUILT_IN_NODES_SOURCES_FOLDER)$(PATHSEP)BuiltInCommands.cpp \
			
BUILT_IN_NODES_OBJECTS_FOLDER = $(OBJECTS_FOLDER)$(PATHSEP)$(BUILT_IN_NODES_LIB_NAME)
BUILT_IN_NODES_OBJECTS = $(BUILT_IN_NODES_SOURCE_FILES:$(BUILT_IN_NODES_SOURCES_FOLDER)$(PATHSEP)%.cpp=$(BUILT_IN_NODES_OBJECTS_FOLDER)$(PATHSEP)%.o)

$(BUILT_IN_NODES_LIB) : $(BUILT_IN_NODES_OBJECTS)
	$(COMPILER) -shared -o $@ $^ -L$(BINARIES_FOLDER) -l$(NODE_ENGINE_LIB_NAME) -l$(NODE_UI_ENGINE_LIB_NAME)

$(BUILT_IN_NODES_OBJECTS_FOLDER) :
	mkdir -p $(BUILT_IN_NODES_OBJECTS_FOLDER)

$(BUILT_IN_NODES_OBJECTS_FOLDER)$(PATHSEP)%.o : $(BUILT_IN_NODES_SOURCES_FOLDER)$(PATHSEP)%.cpp | $(BUILT_IN_NODES_OBJECTS_FOLDER)
	$(COMPILER) -I$(NODE_ENGINE_HEADERS_FOLDER) -I$(NODE_UI_ENGINE_HEADERS_FOLDER) -I$(BUILT_IN_NODES_HEADERS_FOLDER) $(COMPILER_FLAGS) -o $@ -c $<

# NodeEngineTest

NODE_ENGINE_TEST_FRAMEWORK_FOLDER = $(SOURCES_FOLDER)$(PATHSEP)TestFramework
NODE_ENGINE_TEST_FRAMEWORK_SOURCE_FILES = \
	$(NODE_ENGINE_TEST_FRAMEWORK_FOLDER)$(PATHSEP)SimpleTest.cpp \

NODE_ENGINE_TEST_SOURCES_FOLDER = $(SOURCES_FOLDER)$(PATHSEP)$(NODE_ENGINE_TEST_EXE_NAME)
NODE_ENGINE_TEST_SOURCE_FILES = \
	$(NODE_ENGINE_TEST_SOURCES_FOLDER)$(PATHSEP)main.cpp \
	$(NODE_ENGINE_TEST_SOURCES_FOLDER)$(PATHSEP)NodeEditorVisualTest.cpp \
	$(NODE_ENGINE_TEST_SOURCES_FOLDER)$(PATHSEP)ChecksumTest.cpp \
	$(NODE_ENGINE_TEST_SOURCES_FOLDER)$(PATHSEP)main.cpp \
	$(NODE_ENGINE_TEST_SOURCES_FOLDER)$(PATHSEP)SerializableTest.cpp \
	$(NODE_ENGINE_TEST_SOURCES_FOLDER)$(PATHSEP)NodeManagerSerializationTest.cpp \
	$(NODE_ENGINE_TEST_SOURCES_FOLDER)$(PATHSEP)MemoryStreamTest.cpp \
	$(NODE_ENGINE_TEST_SOURCES_FOLDER)$(PATHSEP)GeometryTest.cpp \
	$(NODE_ENGINE_TEST_SOURCES_FOLDER)$(PATHSEP)ListValueNodeTest.cpp \
	$(NODE_ENGINE_TEST_SOURCES_FOLDER)$(PATHSEP)TypeHandlingTest.cpp \
	$(NODE_ENGINE_TEST_SOURCES_FOLDER)$(PATHSEP)NodeConnectionTest.cpp \
	$(NODE_ENGINE_TEST_SOURCES_FOLDER)$(PATHSEP)NodeManagerTest.cpp \
	$(NODE_ENGINE_TEST_SOURCES_FOLDER)$(PATHSEP)NodeRecalculationTest.cpp \
	$(NODE_ENGINE_TEST_SOURCES_FOLDER)$(PATHSEP)NodeTest.cpp \
	$(NODE_ENGINE_TEST_SOURCES_FOLDER)$(PATHSEP)NodeValueCacheTest.cpp \
	$(NODE_ENGINE_TEST_SOURCES_FOLDER)$(PATHSEP)NodeValueCombinationTest.cpp \
	$(NODE_ENGINE_TEST_SOURCES_FOLDER)$(PATHSEP)NumberTypeNodeTest.cpp \
	$(NODE_ENGINE_TEST_SOURCES_FOLDER)$(PATHSEP)UIEngineTest.cpp \
	$(NODE_ENGINE_TEST_SOURCES_FOLDER)$(PATHSEP)UINodeTest.cpp \
	$(NODE_ENGINE_TEST_SOURCES_FOLDER)$(PATHSEP)ValueCombinationTest.cpp \
	$(NODE_ENGINE_TEST_SOURCES_FOLDER)$(PATHSEP)ValueTest.cpp \
	$(NODE_ENGINE_TEST_SOURCES_FOLDER)$(PATHSEP)VisualTestFramework.cpp \
			
NODE_ENGINE_TEST_FRAMEWORK_OBJECTS_FOLDER = $(OBJECTS_FOLDER)$(PATHSEP)TestFramework
NODE_ENGINE_TEST_FRAMEWORK_OBJECTS = $(NODE_ENGINE_TEST_FRAMEWORK_SOURCE_FILES:$(NODE_ENGINE_TEST_FRAMEWORK_FOLDER)$(PATHSEP)%.cpp=$(NODE_ENGINE_TEST_FRAMEWORK_OBJECTS_FOLDER)$(PATHSEP)%.o)

$(NODE_ENGINE_TEST_FRAMEWORK_OBJECTS_FOLDER):
	mkdir -p $(NODE_ENGINE_TEST_FRAMEWORK_OBJECTS_FOLDER)

$(NODE_ENGINE_TEST_FRAMEWORK_OBJECTS_FOLDER)$(PATHSEP)%.o : $(NODE_ENGINE_TEST_FRAMEWORK_FOLDER)$(PATHSEP)%.cpp | $(NODE_ENGINE_TEST_FRAMEWORK_OBJECTS_FOLDER)
	$(COMPILER) -I$(NODE_ENGINE_TEST_FRAMEWORK_FOLDER) $(COMPILER_FLAGS) -o $@ -c $<
	
NODE_ENGINE_TEST_OBJECTS_FOLDER = $(OBJECTS_FOLDER)$(PATHSEP)$(NODE_ENGINE_TEST_EXE_NAME)
NODE_ENGINE_TEST_OBJECTS = $(NODE_ENGINE_TEST_SOURCE_FILES:$(NODE_ENGINE_TEST_SOURCES_FOLDER)$(PATHSEP)%.cpp=$(NODE_ENGINE_TEST_OBJECTS_FOLDER)$(PATHSEP)%.o)

NODE_ENGINE_TEST_FILES_SOURCCE_FOLDER = $(NODE_ENGINE_TEST_SOURCES_FOLDER)$(PATHSEP)VisualTestFiles
NODE_ENGINE_TEST_FILES_FOLDER = $(BINARIES_FOLDER)$(PATHSEP)VisualTestFiles

$(NODE_ENGINE_TEST_EXE) : $(NODE_ENGINE_TEST_OBJECTS) $(NODE_ENGINE_TEST_FRAMEWORK_OBJECTS)
	$(COMPILER) -o $@ $^ -L$(BINARIES_FOLDER) -l$(NODE_ENGINE_LIB_NAME) -l$(NODE_UI_ENGINE_LIB_NAME) -l$(BUILT_IN_NODES_LIB_NAME)
	mkdir -p $(NODE_ENGINE_TEST_FILES_FOLDER)
	$(call CopyFiles,$(NODE_ENGINE_TEST_FILES_SOURCCE_FOLDER)$(PATHSEP)*,$(NODE_ENGINE_TEST_FILES_FOLDER))

$(NODE_ENGINE_TEST_OBJECTS_FOLDER):
	mkdir -p $(NODE_ENGINE_TEST_OBJECTS_FOLDER)

$(NODE_ENGINE_TEST_OBJECTS_FOLDER)$(PATHSEP)%.o : $(NODE_ENGINE_TEST_SOURCES_FOLDER)$(PATHSEP)%.cpp | $(NODE_ENGINE_TEST_OBJECTS_FOLDER)
	$(COMPILER) -I$(NODE_ENGINE_HEADERS_FOLDER) -I$(NODE_UI_ENGINE_HEADERS_FOLDER) -I$(BUILT_IN_NODES_HEADERS_FOLDER) -I$(NODE_ENGINE_TEST_FRAMEWORK_FOLDER) $(COMPILER_FLAGS) -o $@ -c $<
