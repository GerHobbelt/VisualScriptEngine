COMPILER = $(CXX)
COMPILER_FLAGS = -Wall -std=c++11
COMPATIBLE_OS = 0

SOURCES_FOLDER = ..$(PATHSEP)..$(PATHSEP)Sources
RELEASE_BINARIES_FOLDER = ReleaseBinaries
DEBUG_BINARIES_FOLDER = DebugBinaries

BINARIES_FOLDER = 

ifeq ($(RELEASE), 1)
BINARIES_FOLDER = $(RELEASE_BINARIES_FOLDER)
else
COMPILER_FLAGS += -DDEBUG -g
BINARIES_FOLDER = $(DEBUG_BINARIES_FOLDER)
endif

OBJECTS_FOLDER = $(BINARIES_FOLDER)$(PATHSEP)Objects

LIBRARY_PREFIX =
LIBRARY_EXTENSION =
EXECUTABLE_EXTENSION =
COMPATIBLE_OS =
PATHSEP =

ifeq ($(OS), Windows_NT)
	LIBRARY_EXTENSION = .lib
	EXECUTABLE_EXTENSION = .exe
	COMPATIBLE_OS = 1
	PATHSEP = \\
else
	UNAME = $(shell uname -s)
	ifeq ($(UNAME), Linux)
		CURRENTPATH = $(shell pwd)
		export LD_LIBRARY_PATH = $(CURRENTPATH)/$(BINARIES_FOLDER):$LD_LIBRARY_PATH
		LIBRARY_PREFIX = lib
		LIBRARY_EXTENSION = .so
		COMPILER_FLAGS += -fPIC
		COMPATIBLE_OS = 1
		PATHSEP = /
	endif
endif

ifeq ($(OS), Windows_NT)
define CopyFiles
	xcopy "$(1)" "$(2)" /I /D /Y
endef
else
define CopyFiles
	rsync $(1) $(2) -c
endef
endif

ifeq ($(COMPATIBLE_OS), 0)
$(error Incompatible operating system)
endif

NODE_ENGINE_LIB_NAME = NodeEngine
NODE_ENGINE_LIB = $(BINARIES_FOLDER)$(PATHSEP)$(LIBRARY_PREFIX)$(NODE_ENGINE_LIB_NAME)$(LIBRARY_EXTENSION)

NODE_UI_ENGINE_LIB_NAME = NodeUIEngine
NODE_UI_ENGINE_LIB = $(BINARIES_FOLDER)$(PATHSEP)$(LIBRARY_PREFIX)$(NODE_UI_ENGINE_LIB_NAME)$(LIBRARY_EXTENSION)

BUILT_IN_NODES_LIB_NAME = BuiltInNodes
BUILT_IN_NODES_LIB = $(BINARIES_FOLDER)$(PATHSEP)$(LIBRARY_PREFIX)$(BUILT_IN_NODES_LIB_NAME)$(LIBRARY_EXTENSION)

NODE_ENGINE_TEST_EXE_NAME = NodeEngineTest
NODE_ENGINE_TEST_EXE = $(BINARIES_FOLDER)$(PATHSEP)$(NODE_ENGINE_TEST_EXE_NAME)$(EXECUTABLE_EXTENSION)

ALL_TARGETS = $(NODE_ENGINE_LIB) $(NODE_UI_ENGINE_LIB) $(BUILT_IN_NODES_LIB) $(NODE_ENGINE_TEST_EXE)

all: $(ALL_TARGETS)

test:
	$(NODE_ENGINE_TEST_EXE)

clean:
	rm -rf $(DEBUG_BINARIES_FOLDER)
	rm -rf $(RELEASE_BINARIES_FOLDER)

# NodeEngine

NODE_ENGINE_HEADERS_FOLDER = $(SOURCES_FOLDER)$(PATHSEP)$(NODE_ENGINE_LIB_NAME)$(PATHSEP)Headers
NODE_ENGINE_SOURCES_FOLDER = $(SOURCES_FOLDER)$(PATHSEP)$(NODE_ENGINE_LIB_NAME)$(PATHSEP)Sources
NODE_ENGINE_SOURCE_FILES = \
	$(NODE_ENGINE_SOURCES_FOLDER)$(PATHSEP)NE_Checksum.cpp \
	$(NODE_ENGINE_SOURCES_FOLDER)$(PATHSEP)NE_ConnectionManager.cpp \
	$(NODE_ENGINE_SOURCES_FOLDER)$(PATHSEP)NE_Debug.cpp \
	$(NODE_ENGINE_SOURCES_FOLDER)$(PATHSEP)NE_EvaluationEnv.cpp \
	$(NODE_ENGINE_SOURCES_FOLDER)$(PATHSEP)NE_InputSlot.cpp \
	$(NODE_ENGINE_SOURCES_FOLDER)$(PATHSEP)NE_MemoryStream.cpp \
	$(NODE_ENGINE_SOURCES_FOLDER)$(PATHSEP)NE_Node.cpp \
	$(NODE_ENGINE_SOURCES_FOLDER)$(PATHSEP)NE_NodeEngineUtilities.cpp \
	$(NODE_ENGINE_SOURCES_FOLDER)$(PATHSEP)NE_NodeId.cpp \
	$(NODE_ENGINE_SOURCES_FOLDER)$(PATHSEP)NE_NodeManager.cpp \
	$(NODE_ENGINE_SOURCES_FOLDER)$(PATHSEP)NE_NodeValueCache.cpp \
	$(NODE_ENGINE_SOURCES_FOLDER)$(PATHSEP)NE_OutputSlot.cpp \
	$(NODE_ENGINE_SOURCES_FOLDER)$(PATHSEP)NE_SingleValues.cpp \
	$(NODE_ENGINE_SOURCES_FOLDER)$(PATHSEP)NE_Serializable.cpp \
	$(NODE_ENGINE_SOURCES_FOLDER)$(PATHSEP)NE_Stamp.cpp \
	$(NODE_ENGINE_SOURCES_FOLDER)$(PATHSEP)NE_Stream.cpp \
	$(NODE_ENGINE_SOURCES_FOLDER)$(PATHSEP)NE_StringUtils.cpp \
	$(NODE_ENGINE_SOURCES_FOLDER)$(PATHSEP)NE_Slot.cpp \
	$(NODE_ENGINE_SOURCES_FOLDER)$(PATHSEP)NE_SlotId.cpp \
	$(NODE_ENGINE_SOURCES_FOLDER)$(PATHSEP)NE_Value.cpp \
	$(NODE_ENGINE_SOURCES_FOLDER)$(PATHSEP)NE_ValueCombination.cpp \

NODE_ENGINE_OBJECTS_FOLDER = $(OBJECTS_FOLDER)$(PATHSEP)$(NODE_ENGINE_LIB_NAME)
NODE_ENGINE_OBJECTS = $(NODE_ENGINE_SOURCE_FILES:$(NODE_ENGINE_SOURCES_FOLDER)$(PATHSEP)%.cpp=$(NODE_ENGINE_OBJECTS_FOLDER)$(PATHSEP)%.o)

$(NODE_ENGINE_LIB) : $(NODE_ENGINE_OBJECTS)
	$(COMPILER) -shared -o $@ $^

$(NODE_ENGINE_OBJECTS_FOLDER) :
	mkdir -p $(NODE_ENGINE_OBJECTS_FOLDER)

$(NODE_ENGINE_OBJECTS_FOLDER)$(PATHSEP)%.o : $(NODE_ENGINE_SOURCES_FOLDER)$(PATHSEP)%.cpp | $(NODE_ENGINE_OBJECTS_FOLDER)
	$(COMPILER) -I$(NODE_ENGINE_HEADERS_FOLDER) $(COMPILER_FLAGS) -o $@ -c $<

# NodeUIEngine

NODE_UI_ENGINE_HEADERS_FOLDER = $(SOURCES_FOLDER)$(PATHSEP)$(NODE_UI_ENGINE_LIB_NAME)$(PATHSEP)Headers
NODE_UI_ENGINE_SOURCES_FOLDER = $(SOURCES_FOLDER)$(PATHSEP)$(NODE_UI_ENGINE_LIB_NAME)$(PATHSEP)Sources
NODE_UI_ENGINE_SOURCE_FILES = \
	$(NODE_UI_ENGINE_SOURCES_FOLDER)$(PATHSEP)NUIE_CommandStructure.cpp \
	$(NODE_UI_ENGINE_SOURCES_FOLDER)$(PATHSEP)NUIE_ContextDecorators.cpp \
	$(NODE_UI_ENGINE_SOURCES_FOLDER)$(PATHSEP)NUIE_CopyPasteHandler.cpp \
	$(NODE_UI_ENGINE_SOURCES_FOLDER)$(PATHSEP)NUIE_Drawing.cpp \
	$(NODE_UI_ENGINE_SOURCES_FOLDER)$(PATHSEP)NUIE_DrawingContext.cpp \
	$(NODE_UI_ENGINE_SOURCES_FOLDER)$(PATHSEP)NUIE_DrawingImage.cpp \
	$(NODE_UI_ENGINE_SOURCES_FOLDER)$(PATHSEP)NUIE_Geometry.cpp \
	$(NODE_UI_ENGINE_SOURCES_FOLDER)$(PATHSEP)NUIE_InputEventHandler.cpp \
	$(NODE_UI_ENGINE_SOURCES_FOLDER)$(PATHSEP)NUIE_NodeCollection.cpp \
	$(NODE_UI_ENGINE_SOURCES_FOLDER)$(PATHSEP)NUIE_NodeDrawingImage.cpp \
	$(NODE_UI_ENGINE_SOURCES_FOLDER)$(PATHSEP)NUIE_NodeEditor.cpp \
	$(NODE_UI_ENGINE_SOURCES_FOLDER)$(PATHSEP)NUIE_NodeUIEnvironment.cpp \
	$(NODE_UI_ENGINE_SOURCES_FOLDER)$(PATHSEP)NUIE_NodeUIInteractionHandler.cpp \
	$(NODE_UI_ENGINE_SOURCES_FOLDER)$(PATHSEP)NUIE_NodeUIManager.cpp \
	$(NODE_UI_ENGINE_SOURCES_FOLDER)$(PATHSEP)NUIE_NodeUIManagerDrawer.cpp \
	$(NODE_UI_ENGINE_SOURCES_FOLDER)$(PATHSEP)NUIE_NodeUIPanelDrawer.cpp \
	$(NODE_UI_ENGINE_SOURCES_FOLDER)$(PATHSEP)NUIE_SkinParams.cpp \
	$(NODE_UI_ENGINE_SOURCES_FOLDER)$(PATHSEP)NUIE_SvgDrawingContext.cpp \
	$(NODE_UI_ENGINE_SOURCES_FOLDER)$(PATHSEP)NUIE_UIEventHandlers.cpp \
	$(NODE_UI_ENGINE_SOURCES_FOLDER)$(PATHSEP)NUIE_UIInputSlot.cpp \
	$(NODE_UI_ENGINE_SOURCES_FOLDER)$(PATHSEP)NUIE_UIItemFinder.cpp \
	$(NODE_UI_ENGINE_SOURCES_FOLDER)$(PATHSEP)NUIE_UINode.cpp \
	$(NODE_UI_ENGINE_SOURCES_FOLDER)$(PATHSEP)NUIE_UINodeCommandRegistration.cpp \
	$(NODE_UI_ENGINE_SOURCES_FOLDER)$(PATHSEP)NUIE_UINodeCommandStructure.cpp \
	$(NODE_UI_ENGINE_SOURCES_FOLDER)$(PATHSEP)NUIE_UINodeGroup.cpp \
	$(NODE_UI_ENGINE_SOURCES_FOLDER)$(PATHSEP)NUIE_UINodeParameterAccessor.cpp \
	$(NODE_UI_ENGINE_SOURCES_FOLDER)$(PATHSEP)NUIE_UINodeParameters.cpp \
	$(NODE_UI_ENGINE_SOURCES_FOLDER)$(PATHSEP)NUIE_UIOutputSlot.cpp \
	$(NODE_UI_ENGINE_SOURCES_FOLDER)$(PATHSEP)NUIE_ViewBox.cpp \
			
NODE_UI_ENGINE_OBJECTS_FOLDER = $(OBJECTS_FOLDER)$(PATHSEP)$(NODE_UI_ENGINE_LIB_NAME)
NODE_UI_ENGINE_OBJECTS = $(NODE_UI_ENGINE_SOURCE_FILES:$(NODE_UI_ENGINE_SOURCES_FOLDER)$(PATHSEP)%.cpp=$(NODE_UI_ENGINE_OBJECTS_FOLDER)$(PATHSEP)%.o)

$(NODE_UI_ENGINE_LIB) : $(NODE_UI_ENGINE_OBJECTS)
	$(COMPILER) -shared -o $@ $^ -L$(BINARIES_FOLDER) -l$(NODE_ENGINE_LIB_NAME)

$(NODE_UI_ENGINE_OBJECTS_FOLDER) :
	mkdir -p $(NODE_UI_ENGINE_OBJECTS_FOLDER)

$(NODE_UI_ENGINE_OBJECTS_FOLDER)$(PATHSEP)%.o : $(NODE_UI_ENGINE_SOURCES_FOLDER)$(PATHSEP)%.cpp | $(NODE_UI_ENGINE_OBJECTS_FOLDER)
	$(COMPILER) -I$(NODE_ENGINE_HEADERS_FOLDER) -I$(NODE_UI_ENGINE_HEADERS_FOLDER) $(COMPILER_FLAGS) -o $@ -c $<

# BuiltInNodes

BUILT_IN_NODES_HEADERS_FOLDER = $(SOURCES_FOLDER)$(PATHSEP)$(BUILT_IN_NODES_LIB_NAME)$(PATHSEP)Headers
BUILT_IN_NODES_SOURCES_FOLDER = $(SOURCES_FOLDER)$(PATHSEP)$(BUILT_IN_NODES_LIB_NAME)$(PATHSEP)Sources
BUILT_IN_NODES_SOURCE_FILES = \
	$(BUILT_IN_NODES_SOURCES_FOLDER)$(PATHSEP)BI_ArithmeticUINodes.cpp \
	$(BUILT_IN_NODES_SOURCES_FOLDER)$(PATHSEP)BI_BuiltInFeatures.cpp \
	$(BUILT_IN_NODES_SOURCES_FOLDER)$(PATHSEP)BI_InputUINodes.cpp \
	$(BUILT_IN_NODES_SOURCES_FOLDER)$(PATHSEP)BI_ViewerUINodes.cpp \
	$(BUILT_IN_NODES_SOURCES_FOLDER)$(PATHSEP)BI_UINodeLayouts.cpp \
	$(BUILT_IN_NODES_SOURCES_FOLDER)$(PATHSEP)BI_UINodePanels.cpp \
	$(BUILT_IN_NODES_SOURCES_FOLDER)$(PATHSEP)BI_BuiltInCommands.cpp \
			
BUILT_IN_NODES_OBJECTS_FOLDER = $(OBJECTS_FOLDER)$(PATHSEP)$(BUILT_IN_NODES_LIB_NAME)
BUILT_IN_NODES_OBJECTS = $(BUILT_IN_NODES_SOURCE_FILES:$(BUILT_IN_NODES_SOURCES_FOLDER)$(PATHSEP)%.cpp=$(BUILT_IN_NODES_OBJECTS_FOLDER)$(PATHSEP)%.o)

$(BUILT_IN_NODES_LIB) : $(BUILT_IN_NODES_OBJECTS)
	$(COMPILER) -shared -o $@ $^ -L$(BINARIES_FOLDER) -l$(NODE_ENGINE_LIB_NAME) -l$(NODE_UI_ENGINE_LIB_NAME)

$(BUILT_IN_NODES_OBJECTS_FOLDER) :
	mkdir -p $(BUILT_IN_NODES_OBJECTS_FOLDER)

$(BUILT_IN_NODES_OBJECTS_FOLDER)$(PATHSEP)%.o : $(BUILT_IN_NODES_SOURCES_FOLDER)$(PATHSEP)%.cpp | $(BUILT_IN_NODES_OBJECTS_FOLDER)
	$(COMPILER) -I$(NODE_ENGINE_HEADERS_FOLDER) -I$(NODE_UI_ENGINE_HEADERS_FOLDER) -I$(BUILT_IN_NODES_HEADERS_FOLDER) $(COMPILER_FLAGS) -o $@ -c $<

# NodeEngineTest

NODE_ENGINE_TEST_FRAMEWORK_FOLDER = $(SOURCES_FOLDER)$(PATHSEP)TestFramework
NODE_ENGINE_TEST_FRAMEWORK_SOURCE_FILES = \
	$(NODE_ENGINE_TEST_FRAMEWORK_FOLDER)$(PATHSEP)SimpleTest.cpp \

NODE_ENGINE_TEST_SOURCES_FOLDER = $(SOURCES_FOLDER)$(PATHSEP)$(NODE_ENGINE_TEST_EXE_NAME)
NODE_ENGINE_TEST_SOURCE_FILES = \
	$(NODE_ENGINE_TEST_SOURCES_FOLDER)$(PATHSEP)main.cpp \
	$(NODE_ENGINE_TEST_SOURCES_FOLDER)$(PATHSEP)ArithmeticNodesTest.cpp \
	$(NODE_ENGINE_TEST_SOURCES_FOLDER)$(PATHSEP)ChecksumTest.cpp \
	$(NODE_ENGINE_TEST_SOURCES_FOLDER)$(PATHSEP)SerializableTest.cpp \
	$(NODE_ENGINE_TEST_SOURCES_FOLDER)$(PATHSEP)NodeManagerSerializationTest.cpp \
	$(NODE_ENGINE_TEST_SOURCES_FOLDER)$(PATHSEP)MemoryStreamTest.cpp \
	$(NODE_ENGINE_TEST_SOURCES_FOLDER)$(PATHSEP)GeometryTest.cpp \
	$(NODE_ENGINE_TEST_SOURCES_FOLDER)$(PATHSEP)ListValueNodeTest.cpp \
	$(NODE_ENGINE_TEST_SOURCES_FOLDER)$(PATHSEP)TypeHandlingTest.cpp \
	$(NODE_ENGINE_TEST_SOURCES_FOLDER)$(PATHSEP)NodeConnectionTest.cpp \
	$(NODE_ENGINE_TEST_SOURCES_FOLDER)$(PATHSEP)NodeEditorVisualTest.cpp \
	$(NODE_ENGINE_TEST_SOURCES_FOLDER)$(PATHSEP)NodeManagerMergeTest.cpp \
	$(NODE_ENGINE_TEST_SOURCES_FOLDER)$(PATHSEP)NodeManagerTest.cpp \
	$(NODE_ENGINE_TEST_SOURCES_FOLDER)$(PATHSEP)NodeRecalculationTest.cpp \
	$(NODE_ENGINE_TEST_SOURCES_FOLDER)$(PATHSEP)NodeTest.cpp \
	$(NODE_ENGINE_TEST_SOURCES_FOLDER)$(PATHSEP)NodeValueCacheTest.cpp \
	$(NODE_ENGINE_TEST_SOURCES_FOLDER)$(PATHSEP)NodeValueCombinationTest.cpp \
	$(NODE_ENGINE_TEST_SOURCES_FOLDER)$(PATHSEP)NumberTypeNodeTest.cpp \
	$(NODE_ENGINE_TEST_SOURCES_FOLDER)$(PATHSEP)TestNodes.cpp \
	$(NODE_ENGINE_TEST_SOURCES_FOLDER)$(PATHSEP)UIEngineTest.cpp \
	$(NODE_ENGINE_TEST_SOURCES_FOLDER)$(PATHSEP)UINodeTest.cpp \
	$(NODE_ENGINE_TEST_SOURCES_FOLDER)$(PATHSEP)ValueCombinationTest.cpp \
	$(NODE_ENGINE_TEST_SOURCES_FOLDER)$(PATHSEP)ValueTest.cpp \
	$(NODE_ENGINE_TEST_SOURCES_FOLDER)$(PATHSEP)VisualTestFramework.cpp \
			
NODE_ENGINE_TEST_FRAMEWORK_OBJECTS_FOLDER = $(OBJECTS_FOLDER)$(PATHSEP)TestFramework
NODE_ENGINE_TEST_FRAMEWORK_OBJECTS = $(NODE_ENGINE_TEST_FRAMEWORK_SOURCE_FILES:$(NODE_ENGINE_TEST_FRAMEWORK_FOLDER)$(PATHSEP)%.cpp=$(NODE_ENGINE_TEST_FRAMEWORK_OBJECTS_FOLDER)$(PATHSEP)%.o)

$(NODE_ENGINE_TEST_FRAMEWORK_OBJECTS_FOLDER):
	mkdir -p $(NODE_ENGINE_TEST_FRAMEWORK_OBJECTS_FOLDER)

$(NODE_ENGINE_TEST_FRAMEWORK_OBJECTS_FOLDER)$(PATHSEP)%.o : $(NODE_ENGINE_TEST_FRAMEWORK_FOLDER)$(PATHSEP)%.cpp | $(NODE_ENGINE_TEST_FRAMEWORK_OBJECTS_FOLDER)
	$(COMPILER) -I$(NODE_ENGINE_TEST_FRAMEWORK_FOLDER) $(COMPILER_FLAGS) -o $@ -c $<
	
NODE_ENGINE_TEST_OBJECTS_FOLDER = $(OBJECTS_FOLDER)$(PATHSEP)$(NODE_ENGINE_TEST_EXE_NAME)
NODE_ENGINE_TEST_OBJECTS = $(NODE_ENGINE_TEST_SOURCE_FILES:$(NODE_ENGINE_TEST_SOURCES_FOLDER)$(PATHSEP)%.cpp=$(NODE_ENGINE_TEST_OBJECTS_FOLDER)$(PATHSEP)%.o)

NODE_ENGINE_TEST_FILES_SOURCCE_FOLDER = $(NODE_ENGINE_TEST_SOURCES_FOLDER)$(PATHSEP)VisualTestFiles
NODE_ENGINE_TEST_FILES_FOLDER = $(BINARIES_FOLDER)$(PATHSEP)VisualTestFiles

$(NODE_ENGINE_TEST_EXE) : $(NODE_ENGINE_TEST_OBJECTS) $(NODE_ENGINE_TEST_FRAMEWORK_OBJECTS)
	$(COMPILER) -o $@ $^ -L$(BINARIES_FOLDER) -l$(NODE_ENGINE_LIB_NAME) -l$(NODE_UI_ENGINE_LIB_NAME) -l$(BUILT_IN_NODES_LIB_NAME)
	mkdir -p $(NODE_ENGINE_TEST_FILES_FOLDER)
	$(call CopyFiles,$(NODE_ENGINE_TEST_FILES_SOURCCE_FOLDER)$(PATHSEP)*,$(NODE_ENGINE_TEST_FILES_FOLDER))

$(NODE_ENGINE_TEST_OBJECTS_FOLDER):
	mkdir -p $(NODE_ENGINE_TEST_OBJECTS_FOLDER)

$(NODE_ENGINE_TEST_OBJECTS_FOLDER)$(PATHSEP)%.o : $(NODE_ENGINE_TEST_SOURCES_FOLDER)$(PATHSEP)%.cpp | $(NODE_ENGINE_TEST_OBJECTS_FOLDER)
	$(COMPILER) -I$(NODE_ENGINE_HEADERS_FOLDER) -I$(NODE_UI_ENGINE_HEADERS_FOLDER) -I$(BUILT_IN_NODES_HEADERS_FOLDER) -I$(NODE_ENGINE_TEST_FRAMEWORK_FOLDER) $(COMPILER_FLAGS) -o $@ -c $<
